
# Домашнее задание №4


*	**создайте новый кластер PostgresSQL 14**
*	**зайдите в созданный кластер под пользователем postgres**
*	**создайте новую базу данных testdb**
*	**зайдите в созданную базу данных под пользователем postgres**
*	**создайте новую схему testnm**
*	**создайте новую таблицу t1 с одной колонкой c1 типа integer**
*	**вставьте строку со значением c1=1**
*	**создайте новую роль readonly**
*	**дайте новой роли право на подключение к базе данных testdb**
*	**дайте новой роли право на использование схемы testnm**
*	**дайте новой роли право на select для всех таблиц схемы testnm**
*	**создайте пользователя testread с паролем test123**
*	**дайте роль readonly пользователю testread**
*	**зайдите под пользователем testread в базу данных testdb**
*	**сделайте select * from t1;**
*	**получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)**
*	**напишите что именно произошло в тексте домашнего задания**
*	**у вас есть идеи почему? ведь права то дали?**
*	**посмотрите на список таблиц**
*	**подсказка в шпаргалке под пунктом 20**
*	**а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)**
*	**вернитесь в базу данных testdb под пользователем postgres**
*	**удалите таблицу t1**
*	**создайте ее заново но уже с явным указанием имени схемы testnm**
*	**вставьте строку со значением c1=1**
*	**зайдите под пользователем testread в базу данных testdb**
*	**сделайте select * from testnm.t1;**
*	**получилось?**
*	**есть идеи почему? если нет - смотрите шпаргалку**
*	**как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку**
*	**сделайте select * from testnm.t1;**
*	**получилось?**
*	**есть идеи почему? если нет - смотрите шпаргалку**
*	**сделайте select * from testnm.t1;**
*	**получилось?**
*	**ура!**
*	**теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);**
*	**а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?**
*	**есть идеи как убрать эти права? если нет - смотрите шпаргалку**
*	**если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды**
*	**теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);**
*	**расскажите что получилось и почему**

создайте новый кластер PostgresSQL 14.
![Альт-текст](Images/HW4/01.png)

зайдите в созданный кластер под пользователем postgres.
создайте новую базу данных testdb.
зайдите в созданную базу данных под пользователем postgres.
![Альт-текст](Images/HW4/02.png)

создайте новую схему testnm.
создайте новую таблицу t1 с одной колонкой c1 типа integer.
вставьте строку со значением c1=1.
создайте новую роль readonly.
дайте новой роли право на подключение к базе данных testdb.
дайте новой роли право на использование схемы testnm.
дайте новой роли право на select для всех таблиц схемы testnm.
создайте пользователя testread с паролем test123.
дайте роль readonly пользователю testread.
![Альт-текст](Images/HW4/03.png)

зайдите под пользователем testread в базу данных testdb.
![Альт-текст](Images/HW4/04.png)
Для того чтобы не было данной ошибки поправил файл pg_hba.conf.
![Альт-текст](Images/HW4/05.png)  
![Альт-текст](Images/HW4/06.png)

сделайте select * from t1;.
получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже).
напишите что именно произошло в тексте домашнего задания.
у вас есть идеи почему? ведь права то дали?
посмотрите на список таблиц.
подсказка в шпаргалке под пунктом 20
а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)
![Альт-текст](Images/HW3/07.png)
Делал по шпаргалке, так как очень экономит время. Выдало ошибку. Нет прав, потому что таблица создалась в схеме public. На эту схемы у роли readonly нет прав.
Создалось в public так как в search_path лежит "$user", public. Первый элемент ($user) ссылается на схему с именем текущего пользователя, то есть, как я понимаю, если бы назвали нашу схему не testnm, а по имени пользователя - testread то таблица бы сохранилась в этой схеме и ошибки бы не было (естественно, при условии наличая прав у группы readonly на схему testread). Плюсом к этому, ошибки так же бы не было если бы мы не сменили роль нашего пользователя на readonly. По-умолчанию ему присвоилась роль public, которая имеет права на все действия со схемой public (где и создалась в данном примере наша таблица).


вернитесь в базу данных testdb под пользователем postgres.
удалите таблицу t1.
создайте ее заново но уже с явным указанием имени схемы testnm.
вставьте строку со значением c1=1.
зайдите под пользователем testread в базу данных testdb.
сделайте select * from testnm.t1;.
![Альт-текст](Images/HW4/08.png)

получилось?
- нет
есть идеи почему? если нет - смотрите шпаргалку
- тут я догадался сам, на вновь созданные таблицы мы не давали прав.
как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку
- для возможности доступа к вновь создаваемым таблицам нужно прописать следующие права:
ALTER default privileges in SCHEMA testnm grant SELECT on TABLES to readonly; 


сделайте select * from testnm.t1;.
![Альт-текст](Images/HW4/09.png)
получилось?
- нет
есть идеи почему? если нет - смотрите шпаргалку.
- потому что ALTER default будет действовать для новых таблиц, а grant SELECT on all TABLEs in SCHEMA testnm TO readonly отработал только для существующих на тот момент времени. Надо сделать снова или grant SELECT или пересоздать таблицу.
сделайте select * from testnm.t1;
получилось?
- да
ура!
- о, да


теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);.
![Альт-текст](Images/HW4/10.png)

а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?
есть идеи как убрать эти права? если нет - смотрите шпаргалку.
если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды.
- смотрел в шпаргалку, сам может быть и догадался, но ведь есть шпаргалка)
"
это все потому что search_path указывает в первую очередь на схему public. 
А схема public создается в каждой базе данных по умолчанию. 
И grant на все действия в этой схеме дается роли public. 
А роль public добавляется всем новым пользователям. 
Соответсвенно каждый пользователь может по умолчанию создавать объекты в схеме public любой базы данных, 
ес-но если у него есть право на подключение к этой базе данных. 
Чтобы раз и навсегда забыть про роль public - а в продакшн базе данных про нее лучше забыть - выполните следующие действия 
\c testdb postgres; 
REVOKE CREATE on SCHEMA public FROM public; 
REVOKE ALL on DATABASE testdb FROM public; 
\c testdb testread; 
"




Данная комадна запускалась до и после присоединения нового диска. Появившийся диск выделен рамочкой.  

Так же посмотрел что выдаёт команда: sudo fdisk -l  
![Альт-текст](Images/HW3/02.png)
![Альт-текст](Images/HW3/03.png)  
На основании этой информации сделал вывод, что наш новый диск определился в системе как /dev/vdb.  


Затем той же утилитой fdisk создал раздел, сделал его основным, указал ему номер 1.
![Альт-текст](Images/HW3/04.png)
![Альт-текст](Images/HW3/04_1.png)


Отформатировал раздел в файловую систему ext4.  
![Альт-текст](Images/HW3/05.png)


Создал каталог /mnt/data, сделал пользователя postgres его владельцем, смонтировал в него наш раздел. Узнал UUID раздела и прописал его в /etc/fstab.
![Альт-текст](Images/HW3/06.png)
![Альт-текст](Images/HW3/07.png)

Проверил состояние файловых систем.  
![Альт-текст](Images/HW3/08.png)

Перегрузил ВМ и снова проверил.  
![Альт-текст](Images/HW3/09.png)

Остановил postgres например через sudo -u postgres pg_ctlcluster 14 main stop.
![Альт-текст](Images/HW3/12.png)

Перенёс содержимое /var/lib/postgres/14 в /mnt/data - mv /var/lib/postgresql/14/mnt/data.  
![Альт-текст](Images/HW3/13.png)

Попытайтесь запустить кластер - sudo -u postgres pg_ctlcluster 14 main start.
![Альт-текст](Images/HW3/14.png)  
Выдаёт ошибку, так как не может зачитать каталог с базами данных.

Задание: найти конфигурационный параметр в файлах раположенных в /etc/postgresql/14/main который надо поменять и поменяйте его.  
Нужно внести правку в файл /etc/postgresql/14/main/postgresql.conf:  
![Альт-текст](Images/HW3/25.png)

После этого кластер поднимется и видно что директория с данными теперь используется другая - /mnt/data/14/main:  
![Альт-текст](Images/HW3/26.png)

Можно зайти и проверить, что данные на месте:  
![Альт-текст](Images/HW3/27.png)

Далее отсоединил диск от первой ВМ и присоединил его ко второй. Проделал следующие манипуляции:  
![Альт-текст](Images/HW3/17.png)  
![Альт-текст](Images/HW3/18.png)  
![Альт-текст](Images/HW3/19.png)  
![Альт-текст](Images/HW3/20.png)  
![Альт-текст](Images/HW3/21.png)  
![Альт-текст](Images/HW3/22.png)  
![Альт-текст](Images/HW3/23.png)  
![Альт-текст](Images/HW3/24.png)  
![Альт-текст](Images/HW3/25.png)  
![Альт-текст](Images/HW3/26.png)  
![Альт-текст](Images/HW3/27.png)  

Далее пропишем в etc/fstab UUID раздела, что бы после перезагрузки всё работало, перезагрузим ВМ и проверим:
![Альт-текст](Images/HW3/28.png)  
![Альт-текст](Images/HW3/29.png)  
![Альт-текст](Images/HW3/30.png)  
![Альт-текст](Images/HW3/31.png)

