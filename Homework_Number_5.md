
# Домашнее задание №5


* **Создать инстанс ВМ с 2 ядрами и 4 Гб ОЗУ и SSD 10GB**  
![Альт-текст](Images/HW5/01.png)  

* **Установить на него PostgreSQL 16 с дефолтными настройками**  
![Альт-текст](Images/HW5/02.png)  

* **Создать БД для тестов: выполнить pgbench -i postgres**  
![Альт-текст](Images/HW5/03.png)  
![Альт-текст](Images/HW5/04.png)  

* **Запустить pgbench -c8 -P 6 -T 60 -U postgres postgres**  
![Альт-текст](Images/HW5/05.png)  

* **Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла**  
* **Протестировать заново**  
![Альт-текст](Images/HW5/06.png)
![Альт-текст](Images/HW5/07.png)  

* **Что изменилось и почему?**


* **Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1млн строк**
![Альт-текст](Images/HW5/08.png)  

* **Посмотреть размер файла с таблицей**
![Альт-текст](Images/HW5/09.png)  
  
* **дайте новой роли право на select для всех таблиц схемы testnm.**
* **создайте пользователя testread с паролем test123.**
* **дайте роль readonly пользователю testread.**  
![Альт-текст](Images/HW4/03.png)

* **зайдите под пользователем testread в базу данных testdb.**  
![Альт-текст](Images/HW4/04.png)  
_Для того чтобы не было данной ошибки поправил файл pg_hba.conf._  
![Альт-текст](Images/HW4/05.png)  
![Альт-текст](Images/HW4/06.png)

* **сделайте select * from t1;**  
* **получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже).**  
* **напишите что именно произошло в тексте домашнего задания.**  
* **у вас есть идеи почему? ведь права то дали?**  
* **посмотрите на список таблиц.**  
* **подсказка в шпаргалке под пунктом 20**  
* **а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)**  
![Альт-текст](Images/HW4/07.png)  
_делал по шпаргалке, так как это очень экономит время. Выдало ошибку. Нет прав, потому что таблица создалась в схеме public. На эту схемы у роли readonly нет прав.
Создалось в public так как в search_path лежит "$user", public. Первый элемент ($user) ссылается на схему с именем текущего пользователя, то есть, как я понимаю, если бы назвали нашу схему не testnm, а по имени пользователя - testread то таблица бы сохранилась в этой схеме и ошибки бы не было (естественно, при условии наличая прав у группы readonly на схему testread). Плюсом к этому, ошибки так же бы не было если бы мы не сменили роль нашего пользователя на readonly. По-умолчанию ему присвоилась роль public, которая имеет права на все действия со схемой public (где и создалась в данном примере наша таблица)._




* **вернитесь в базу данных testdb под пользователем postgres.**  
* **удалите таблицу t1.**  
* **создайте ее заново но уже с явным указанием имени схемы testnm.**  
* **вставьте строку со значением c1=1.**  
* **зайдите под пользователем testread в базу данных testdb.**  
* **сделайте select * from testnm.t1;.**  
![Альт-текст](Images/HW4/08.png)  

* **получилось?**  
  _нет_  
* **есть идеи почему? если нет - смотрите шпаргалку**  
  _тут я догадался сам, на вновь созданные таблицы мы не давали прав._  
* **как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку**  
  _для возможности доступа к вновь создаваемым таблицам нужно прописать следующие права:  
  ALTER default privileges in SCHEMA testnm grant SELECT on TABLES to readonly;_  


* **сделайте select * from testnm.t1;**  
* **получилось?**  
  _нет._
* **есть идеи почему? если нет - смотрите шпаргалку.**  
  _потому что ALTER default будет действовать для новых таблиц, а grant SELECT on all TABLEs in SCHEMA testnm TO readonly отработал только для существующих на тот момент времени. Надо сделать снова или grant SELECT или пересоздать таблицу._
* **сделайте select * from testnm.t1;**
* **получилось?**  
  _да._
* **ура!**  
  _о, да._  
![Альт-текст](Images/HW4/09.png)  


* **теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);.**
![Альт-текст](Images/HW4/10.png)  

* **а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?**  
* **есть идеи как убрать эти права? если нет - смотрите шпаргалку.**  
* **если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды.**  
  _смотрел в шпаргалку:
"
это все потому что search_path указывает в первую очередь на схему public. 
А схема public создается в каждой базе данных по умолчанию. 
И grant на все действия в этой схеме дается роли public. 
А роль public добавляется всем новым пользователям. 
Соответсвенно каждый пользователь может по умолчанию создавать объекты в схеме public любой базы данных, 
ес-но если у него есть право на подключение к этой базе данных. 
Чтобы раз и навсегда забыть про роль public - а в продакшн базе данных про нее лучше забыть - выполните следующие действия  
\c testdb postgres;  
REVOKE CREATE on SCHEMA public FROM public;  
REVOKE ALL on DATABASE testdb FROM public;  
\c testdb testread;  
"_  
![Альт-текст](Images/HW4/11.png)  


* **теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);.**  
* **расскажите что получилось и почему.**  
![Альт-текст](Images/HW4/12.png)  
  _теперь не даёт создавать таблицу, так как отобрали права на схему public и базу данных testdb у роли public.  
  что бы создать таблицу нужно указывать нашу схему testnm в команде создания или добавить схему testnm в search_path (привести к виду "$user", testnm, public)._  
  


